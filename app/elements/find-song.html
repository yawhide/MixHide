<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel='import' href='../bower_components/paper-input/paper-input.html'>
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel='import' href='../bower_components/paper-button/paper-button.html'>
<link rel='import' href='../bower_components/core-list/core-list.html'>
<link rel='import' href='../bower_components/core-selector/core-selector.html'>
<link rel='import' href='../bower_components/paper-tabs/paper-tabs.html'>
<link rel='import' href='../bower_components/core-pages/core-pages.html'>
<link rel='import' href='../bower_components/paper-spinner/paper-spinner.html'>
<link rel='import' href='../bower_components/core-icon-button/core-icon-button.html'>
<link rel='import' href='../bower_components/core-icons/av-icons.html'>


<polymer-element name="find-song">
  <template  >
    <link rel='stylesheet' href='../styles/find-song.css'>
    <style>

    </style>
    
    <div>
      <h4>Find a Song</h4>
      <paper-input type='text' label='Enter a Song Name' floatingLabel placeholder='song name' value='{{songName}}' on-keypress="{{keypressHandler}}"></paper-input>
      <paper-button raised role='button' class='hover' on-click='{{searchSong}}'>Find</paper-button>
      <paper-spinner active='{{searchingForSongs}}'></paper-spinner>
    </div>
    

    <template if='{{songsFound}}'>
    <paper-tabs selected="{{selected}}" selectedindex="0" class="transparent-teal">
      <paper-tab>SoundCloud</paper-tab>
      <paper-tab>Youtube</paper-tab>
      <paper-tab>Spotify</paper-tab>
    </paper-tabs>

    <core-pages selected="{{selected}}" selectedindex="0" notap>
      <div>
        <paper-shadow z='2'>
    <core-list data='{{soundCloudSongs}}' selectionEnabled="{{selectionEnabled}}"
    selection="{{selection}}" on-core-activate="{{soundCloudHandler}}">
      <template>
        <div class="item {{ {selected: selected} | tokenList }}">
          <div class="message" style="background-image: url({{model.artwork_url}});">
            <span class="songTitle">{{model.title}}</span>
            <core-icon-button icon="av:play-arrow" on-click="{{playSong}}" disabled?='{{!model.streamable}}' streamid='{{model.id}}'></core-icon-button>
            <div>{{model.duration}}</div>
            <div>{{model.genre}}</div>
            <a target='_blank' href='{{model.permalink_url}}'>View on SoundCloud</a>
          </div>
        </div>
      </template>
    </core-list>
    </paper-shadow>
      </div>
      <div>
         <paper-shadow z='2'>
    <core-list data='{{youtubeSongs}}' selectionEnabled="{{selectionEnabled}}"
    selection="{{selection}}" on-core-activate="{{soundCloudHandler}}">
      <template>
        <div class="item {{ {selected: selected} | tokenList }}">
          <div class="message" style="background-image: url({{model.snippet.thumbnails.default.url}});">
            <span class="songTitle">{{model.snippet.title}}</span>
            <div style='display: none;'>{{model.snippet.description}}</div>
            <a target='_blank' href='https://youtube.com/watch?v={{model.id.videoId}}'>View on Youtube</a>
          </div>
        </div>
      </template>
    </core-list>
    </paper-shadow>
      </div>
      <div>
         <paper-shadow z='2'>
    <core-list data='{{spotifySongs}}' selectionEnabled="{{selectionEnabled}}"
    selection="{{selection}}" on-core-activate="{{soundCloudHandler}}">
      <template>
        <div class="item {{ {selected: selected} | tokenList }}">
          <div class="message" style="background-image: url({{model.album_art.url }});">
            <span class="songTitle">{{model.name}}</span>
            <div>{{model.duration_ms}}</div>
            <a target='_blank' href='{{model.external_urls.spotify}}'>View on Spotify</a>
          </div>
        </div>
      </template>
    </core-list>
    </paper-shadow>
      </div>
    </core-pages>
    </template>

  </template>
  <script>
      Polymer('find-song', {
        currentSongPlaying: {},
        selected: 0,
        keypressHandler: function(event, detail, sender) { 
          if(event.which === 13){
            this.searchSong();
          }
        },
        searchSong: function (){
          var that = this;
          this.searchingForSongs = true;

          Promise.all([this.soundCloudPromise(), this.youtubePromise(), this.spotifyPromise()])
            .done(function (results){
              that.songsFound = true;
              that.songName = '';
              that.searchingForSongs = false;
            }, function (err){
              console.error(err);
              console.error('promise failed');
              that.searchingForSongs = false;
              that.songName = '';
            })
        },
        soundCloudPromise: function (){
          var that = this;
          var soundCloud = new Promise(function (fulfill, reject){
            SC.get('/tracks', { q: that.songName}, function (tracks){
              console.info('soundcloud');
              console.log(tracks);
              if(tracks.length === 0)
                reject('')
              else{
                that.SoundCloudResp = JSON.stringify(tracks);
                that.soundCloudSongs = tracks.slice(0, 10);
                fulfill();
              }
            })
          })
          return soundCloud;
        },
        youtubePromise: function (){
          var that = this;
          var youtube = new Promise(function (fulfill, reject){
            //Youtube
            var request = gapi.client.youtube.search.list({
              q: that.songName,
              part: 'snippet',
              maxResults: 10
            })
            request.execute(function (tracks){
              console.info('youtube')
              console.log(tracks);
              if(tracks.items.length === 0)
                reject('')
              else{
                var str = JSON.stringify(tracks.result);
                that.YouTubeResp = str;
                that.youtubeSongs = tracks.items;
                fulfill();
              }
            })
          })
          return youtube;
        },
        spotifyPromise: function (){
          var that = this;
          var spotify = new Promise(function (fulfill, reject){
            //Spotify
            spotifyApi.searchTracks(that.songName
              , function (err, tracks){
              if(err){
                console.error(err);
                reject(err);
              }
              else{
                console.info('spotify');
                console.log(tracks);
                if(tracks.tracks.items.length === 0)
                  reject();
                else{
                  that.SpotifyResp = JSON.stringify(tracks);
                  that.spotifySongs = tracks.tracks.items.slice(0, 10);
                  that.spotifySongs.map(function (i){
                    i.album_art = i.album?i.album.images.length > 0?i.album.images[0] : '' : ''
                  })
                  fulfill();
                }
              }
          })
          })
          return spotify;
        },
        soundCloudHandler: function (event, detail, sender){

        },
        playSong: function (event, detail, sender){
          var id = sender.getAttribute('streamid');
          var that = this;
          if(this.currentSongPlaying.songPlaying === id){
            if(this.currentSongPlaying.paused)
              this.currentSongPlaying.resume()
            else
              this.currentSongPlaying.pause()
            return;
          } else if (Object.keys(this.currentSongPlaying).length !== 0)
            this.currentSongPlaying.stop();
          SC.stream('/tracks/'+id, function (sound){
            that.currentSongPlaying = sound;
            that.currentSongPlaying.songPlaying = id;
            sound.play();
          })
        }
      })
  </script>
</polymer-element>